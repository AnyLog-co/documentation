# Query Node
While any node can execute a query, as long as `system_query` logical database is active, the _query node_  is 
dedicated to only coordinate the query process(es). When deploying with docker, we recommend deploying [query with 
remote-cli](https://github.com/AnyLog-co/deployments/tree/master/docker-compose/query-remote-cli)    

For a step-by-step process of what's being done in the background, please visit the [deployment process](query_node_deployment_process.md)


## Requirements
* [Node Setup](../prerequisites.md#docker) - including logging into AnyLog's Docker hub

## Process
For a simplified process, feel free to utilize our deployment script. 
```shell
bash $HOME/deployments/deployment_scripts/deploy_node.sh
```

1. Fill-out the Anylog configurations file for [query node](https://github.com/AnyLog-co/deployments/blob/os-dev/docker-compose/query-remote-cli/anylog_configs.env)
   * A location that's not preset will be autogenerated when node is deployed  

File path: `$HOME/deployments/docker-compose/anylog-master/anylog_configs.env`
```dotenv
# --- General ---
# Information regarding which AnyLog node configurations to enable. By default, even if everything is disabled, AnyLog starts TCP and REST connection protocols
NODE_TYPE=query
# Name of the AnyLog instance
NODE_NAME=anylog-query
# Owner of the AnyLog instance
COMPANY_NAME=New Company
# Coordinates of the machine - used by Grafana to map the network
#LOCATION=<GENERAL_LOCATION>
# Country where machine is located
#COUNTRY=<GENERAL_COUNTRY>
# State where machine is located
#STATE=<GENERAL_STATE>
# City where machine is located
#CITY=<GENERAL_CITY>

# --- Networking ---
# External IP address of the machine
#EXTERNAL_IP=<NETWORKING_EXTERNAL_IP>
# Local or  internal network IP address of the machine
#LOCAL_IP=<NETWORKING_LOCAL_IP>
# Configurable (local) IP address that can be used when behind a proxy, or using Kubernetes for static IP
#PROXY_IP=<NETWORKING_PROXY_IP>
# Port address used by AnyLog's TCP protocol to communicate with other nodes in the network
ANYLOG_SERVER_PORT=32348
# Port address used by AnyLog's REST protocol
ANYLOG_REST_PORT=32349
# Port value to be used as an MQTT borker, or some other third-party broker
#ANYLOG_BROKER_PORT=<NETWORKING_ANYLOG_BROKER_PORT>

# --- Database ---
# Physical database type
DB_TYPE=sqlite
# Username for SQL database connection
#DB_USER=<DATABASE_DB_USER>
# Password correlated to database user
#DB_PASSWD=<DATABASE_DB_PASSWD>
# Database IP address
DB_IP=127.0.0.1
# Database port number
DB_PORT=5432
# Whether to set autocommit data
AUTOCOMMIT=false
# Whether to start to start system_query logical database
SYSTEM_QUERY=true
# Run system_query using in-memory SQLite. If set to false, will use pre-set database type
MEMORY=true
# Whether to enable NoSQL logical database
NOSQL_ENABLE=false

# --- Blockchain ---
# TCP connection information for Master Node
LEDGER_CONN=127.0.0.1:32048
# How often to sync from blockchain
SYNC_TIME=30 second
# Source of where the data is coming from
BLOCKCHAIN_SOURCE=master
# Where will the copy of the blockchain be stored
BLOCKCHAIN_DESTINATION=file

# --- MQTT ---
# Whether to enable the default MQTT process
ENABLE_MQTT=false

# --- Advanced Settings ---
# Whether to automatically run a local (or personalized) script at the end of the process
DEPLOY_LOCAL_SCRIPT=false
# Number of TCP threads
TCP_THREAD_POOL=6
# How long to wait until REST timeout
REST_TIMEOUT=30
# Number of REST threads
REST_THREADS=5
# Number of parallel queries
QUERY_POOL=3
# When data comes in write to database immidiately, as opposed to waiting for a full buffer
WRITE_IMMEDIATE=true
# If buffer is not full, how long to wait until pushing data through
THRESHOLD_TIME=60 seconds
# Buffer size to reach, at which point data is pushed through
THRESHOLD_VOLUME=10KB
```

2. By default, AnyLog is deployed using our `predevelop` version. Version changes can be done in the [.env](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/query-remote-cli/.env)

File Path: `$HOME/deployments/docker-compose/query-remote-cli/.env`
```dotenv
BUILD=predevelop
ENV_FILE=anylog_configs.env
CONTAINER_NAME=anylog-query
NETWORK=host
```

3. Deploy Node -- this will also deploy the [Remote-CLI](../Support/Remote-CLI.md) 
```shell
cd $HOME/deployments/docker-compose/query-remote-cli/
docker-compose up -d
```

4. Validate Node is running
* via cURL 
```shell
# Get Status
curl -X GET ${IP_ADDRESS}:32349 -H "command: get status" -H "User-Agent: AnyLog/1.23"  -w "\n"

# Get Processes
curl -X GET ${IP_ADDRESS}:32349 -H "command: get processes" -H "User-Agent: AnyLog/1.23"  -w "\n"
```
* via AnyLog CLI
```shell
# docker attach --detach-keys=ctrl-d anylog-master 
ubuntu@query-node:~$ docker attach --detach-keys=ctrl-d mastaer-node 
AL anylog-query-node +> test node 
--> Test TCP Server ...
run client 23.239.12.151:32348 get status
[From Node 23.239.12.151:32348]  'anylog-query-node@23.239.12.151:32348 running'

--> Test REST Server ...
rest get where url = http://23.239.12.151:32349 and type = info and command = "get status where format = json" and User-Agent = AnyLog/1.23
{'status': 'anylog-query-node@23.239.12.151:32348 running'}
 
--> Test local Blockchain file ...
blockchain test: pass

AL anylog-query-node +> get processes 

    Process         Status       Details                                                                    
    ---------------|------------|--------------------------------------------------------------------------|
    TCP            |Running     |Listening on: 23.239.12.151:32348, Threads Pool: 6                        |
    REST           |Running     |Listening on: 23.239.12.151:32349, Threads Pool: 5, Timeout: 20, SSL: None|
    Operator       |Not declared|                                                                          |
    Publisher      |Not declared|                                                                          |
    Blockchain Sync|Running     |Sync every 30 seconds with master using: 45.79.74.39:32048                |
    Scheduler      |Running     |Schedulers IDs in use: [0 (system)] [1 (user)]                            |
    Distributor    |Not declared|                                                                          |
    Blobs Archiver |Not declared|                                                                          |
    Consumer       |Not declared|                                                                          |
    MQTT           |Not declared|                                                                          |
    Message Broker |Not declared|No active connection                                                      |
    SMTP           |Not declared|                                                                          |
    Streamer       |Running     |Default streaming thresholds are 60 seconds and 10,240 bytes              |
    Query Pool     |Running     |Threads Pool: 3                                                           |
    Kafka Consumer |Not declared|                                                                          |
```
