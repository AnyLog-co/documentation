# Kubernetes Networking

Kubernetes Orchestrator generates a unique virtual IP each time a node is deployed. Due to the changing virtual IP AnyLog
would have issues supporting communication between nodes on the same physical network; especially if the external IP 
isn't open to the public. To resolve this issue we recommend using [Nginx](https://www.nginx.com/) or other proxy service.     

Directions to install Nginx can be found [here](../Networking/nginx.md)  

With the addition of Nginx to Kubernetes, we now have 3 IP addresses: 
* External IP - which is the IP of the network, generated by the router (http://whatismyipaddress.com/) 
* Machine IP - The local IP address of the machine / VM / device thatâ€™s running Kubernetes
* Virtual IP - which is the IP generated by Kubernetes, and is unique for each pod 

With the help of Nginx, AnyLog can utilize the machine IP as a proxy, thus having a consistent IP to communicate locally. 
As such, the deployment works as follows:
* The External & Machine IP are used for setting up TCP connections.
* The Virtual IP is used for setting the REST connection.
* The External & Machine IP are used for setting up Message Broker connections.

The following chart summarizes the setup:

| Connection Type |  External IP | Local IP | Config Command | 
| --- | --- | --- | --- | 
| TCP | External IP | Machine IP | `run tcp server ...` | 
| REST | Virtual IP | Virtual IP | `run rest server ...`| 
| Message Broker | External IP | Machine IP | `run message broker ...` |

In the example below, we have 3 IPs: 
* `67.169.66.209` is our External IP (AnyLog variable `!external_ip`), used to communicate with nodes outside the network
* `10.0.0.209` the (local) IP of the machine (AnyLog variable `!proxy_ip`), used to communicate with nodes within the 
same (physical) network. Note - the user needs to set this value in the configurations in order to use Nginx / have consistent IPs 
* `172.17.0.3` is the virtual IP (AnyLog variable `!ip`) and is generated each time the pod is deployed. This IP is only 
used for initiating the REST connection.

```commandline
# Sample Connections 
AL anylog-master-node +> get connections 
Type      External Address    Local Address    
---------|-------------------|----------------|
TCP      |67.169.66.209:32048|10.0.0.209:32048|
REST     |172.17.0.3:32049   |172.17.0.3:32049|
Messaging|67.169.66.209:32050|10.0.0.209:32050|

# Sample TCP communication
AL anylog-master-node +> run client (10.0.0.209 32048) get status 
[From Node 10.0.0.209:32048]  'anylog-master-node@67.169.66.209:32048 running'


# Sample REST Communication
anylog@pc-ubuntu2004-k8:~$ curl -X GET 10.0.0.209:32049 -H "command: get status" -H "User-Agent: AnyLog/1.23" -w "\n" 
anylog-master-node@67.169.66.209:32048 running
```

## Sample AnyLog Changes 

* When deploying with Kubernetes + Nginx the configurations for networking would look something like this: 
```yaml
 networking:
   server: 32048
   rest: 32049
   # Optional broker port
   broker: 32050
   # Optional external & local IP instead of the default values
   external_ip: ""
   local_ip: ""
   # Proxy IP used by Nginx or other proxy service.
   proxy_ip: 10.0.0.209
```

* The blockchain policy would then decclare the kubernetes proxy IP as its local IP. 
```json 
{"master": {
       "hostname": "al-master",
       "name": "anylog-master",
       "ip": "67.169.66.209",
       "local_ip": "10.0.0.209",
       "company": "AnyLog",
       "port": 32048,
       "rest_port": 32049,
       "loc": "35.6895,139.6917",
       "country": "JP",
       "state": "Tokyo",
       "city": "Tokyo"
}} 
``` 


## Testing
The following are networking combinations we've tested using Kubernetes with Nginx, and verified they are able to 
communicate with one another. 
* Everything on a single Kubernetes cluster, on a single machine. 
* On the same physical network, have an AnyLog node running through Kubernetes cluster & another AnyLog node, on a 
different machine, not using Kubernetes.
* On 2 different physical networks have AnyLog running. One of the AnyLog  nodes running using Kubernetes, while the
other not using Kubernetes. 
* On a single network, have 2 AnyLog instances, both running through Kubernetes, but each on its own machine
* On 2 different physical networks have AnyLog running through Kubernetes. 
