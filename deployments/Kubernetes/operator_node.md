# Operator Node
A node of type operator is responsible for hosting the data. Data can be stored in SQL format (for JSON data) or blobs
in either MongoDB or to file for non-SQL data. When deploying more than 1 operator node on the same machine, it's 
important to make sure that: 
1. the docker service name in [docker-compose](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-operator/docker-compose.yml) is different for each operator
2. That the two don't share a physical database - one should use SQLite and another PostgresSQL 

## Requirements
* [Node Setup](../prerequisites.md#docker) - including logging into AnyLog's Docker hub
* [Postgres](database_configuration.md#postgressql)

## Process
For a simplified process, feel free to utilize our deployment script. 
```shell
bash $HOME/deployments/deployment_scripts/deploy_node.sh
```

1. Fill-out the Anylog configurations file for [operator node](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-operator/anylog_configs.env)
   * Make sure the database credentials are the same as what's configured in your PostgresSQL database
   * Update the `LEDGER_CONN` information so that it can communicate with the master node (or blockchain)
   * When using AnyLog as an MQTT broker, you can set the `MQTT_BROKER` to **local** and the `MQTT_PORT` to the same value
   as `ANYLOG_BROKER_PORT`. 
   * A location that's not preset will be autogenerated when node is deployed  

File path: `$HOME/deployments/docker-compose/anylog-operator/anylog_configs.env`
```dotenv
# --- General ---
# Information regarding which AnyLog node configurations to enable. By default, even if everything is disabled, AnyLog starts TCP and REST connection protocols
NODE_TYPE=operator
# Name of the AnyLog instance
NODE_NAME=anylog-operator
# Owner of the AnyLog instance
COMPANY_NAME=New Company
# Coordinates of the machine - used by Grafana to map the network
#LOCATION=<GENERAL_LOCATION>
# Country where machine is located
#COUNTRY=<GENERAL_COUNTRY>
# State where machine is located
#STATE=<GENERAL_STATE>
# City where machine is located
#CITY=<GENERAL_CITY>

# --- Networking ---
# External IP address of the machine
#EXTERNAL_IP=<NETWORKING_EXTERNAL_IP>
# Local or  internal network IP address of the machine
#LOCAL_IP=<NETWORKING_LOCAL_IP>
# Configurable (local) IP address that can be used when behind a proxy, or using Kubernetes for static IP
#K8S_PROXY_IP=<NETWORKING_K8S_PROXY_IP>
# Port address used by AnyLog's TCP protocol to communicate with other nodes in the network
ANYLOG_SERVER_PORT=32148
# Port address used by AnyLog's REST protocol
ANYLOG_REST_PORT=32149
# Port value to be used as an MQTT borker, or some other third-party broker
#ANYLOG_BROKER_PORT=<NETWORKING_ANYLOG_BROKER_PORT>

# --- Database ---
# Physical database type
DB_TYPE=psql
# Username for SQL database connection
DB_USER=admin
# Password correlated to database user
DB_PASSWD=passwd
# Database IP address
DB_IP=127.0.0.1
# Database port number
DB_PORT=5432
# Whether to set autocommit data
AUTOCOMMIT=false
# Whether to start to start system_query logical database
SYSTEM_QUERY=true
# Run system_query using in-memory SQLite. If set to false, will use pre-set database type
MEMORY=true
# Whether to enable NoSQL logical database
NOSQL_ENABLE=false
# Physical database type
NOSQL_TYPE=mongo
# Username for SQL database connection
#NOSQL_USER=<DATABASE_NOSQL_USER>
# Password correlated to database user
#NOSQL_PASSWD=<DATABASE_NOSQL_PASSWD>
# Database IP address
NOSQL_IP=127.0.0.1
# Database port number
NOSQL_PORT=27017
# Store blobs in database
NOSQL_BLOBS_DBMS=true
# Store blobs in folder
NOSQL_BLOBS_FOLDER=true
# Compress stored blobs
NOSQL_BLOBS_COMPRESS=false
# Whether (re)store a blob if already exists
NOSQL_BLOBS_REUSE=true

# --- Blockchain ---
# TCP connection information for Master Node
LEDGER_CONN=127.0.0.1:32048
# How often to sync from blockchain
SYNC_TIME=30 second
# Source of where the data is coming from
BLOCKCHAIN_SOURCE=master
# Where will the copy of the blockchain be stored
BLOCKCHAIN_DESTINATION=file

# --- Operator ---
# Operator ID
#MEMBER=<OPERATOR_MEMBER>
# Owner of the cluster
CLUSTER_NAME=new-company-cluster
# Logical database name
DEFAULT_DBMS=test
# Whether of not to enable HA against the cluster
ENABLE_HA=false
# How many days back to sync between nodes
START_DATE=30
# Whether to enable partitioning
ENABLE_PARTITIONS=false
# Which tables to partition
TABLE_NAME=*
# Which timestamp column to partition by
PARTITION_COLUMN=insert_timestamp
# Time period to partition by
PARTITION_INTERVAL=14 days
# How many partitions to keep
PARTITION_KEEP=6
# How often to check if an old partition should be removed
PARTITION_SYNC=1 day
# Whether to create a new table in the operator
CREATE_TABLE=true
# Record data inserted on Operator
UPDAE_TSD_INFO=true
# Archive data coming in
ARCHIVE=true
# Compress JSON and SQL file(s) backup
COMPRESS_FILE=true
# How many threads to use in the operator process
OPERATOR_THREADS=1

# --- MQTT ---
# Whether to enable the default MQTT process
ENABLE_MQTT=true
# Whether to enable MQTT logging process
MQTT_LOG=false
# IP address of MQTT broker
MQTT_BROKER=driver.cloudmqtt.com
# Port associated with MQTT broker
MQTT_PORT=18785
# User associated with MQTT broker
MQTT_USER=ibglowct
# Password associated with MQTT user
MQTT_PASSWD=MSY4e009J7ts
# Topic to get data for
MQTT_TOPIC=anylogedgex
# Logical database name
MQTT_DBMS=test
# Table where to store data
MQTT_TABLE=rand_data
# Timestamp column name
MQTT_TIMESTAMP_COLUMN=now
# Value column name
MQTT_VALUE_COLUMN=bring [readings][][value]
# Column value type
MQTT_VALUE_COLUMN_TYPE=float

# --- Advanced Settings ---
# Whether to automatically run a local (or personalized) script at the end of the process
DEPLOY_LOCAL_SCRIPT=false
# Number of TCP threads
TCP_THREAD_POOL=6
# How long to wait until REST timeout
REST_TIMEOUT=30
# Number of REST threads
REST_THREADS=5
# Number of parallel queries
QUERY_POOL=3
# When data comes in write to database immidiately, as opposed to waiting for a full buffer
WRITE_IMMEDIATE=true
# If buffer is not full, how long to wait until pushing data through
THRESHOLD_TIME=60 seconds
# Buffer size to reach, at which point data is pushed through
THRESHOLD_VOLUME=10KB
```

2. By default, AnyLog is deployed using our `predevelop` version. Version changes can be done in the [.env](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-operator/.env)

File Path: `$HOME/deployments/docker-compose/anylog-operator/.env`
```dotenv
BUILD=predevelop
ENV_FILE=anylog_configs.env
CONTAINER_NAME=anylog-master
NETWORK=host
```

3. Deploy Node
```shell
cd $HOME/deployments/docker-compose/anylog-operator/
docker-compose up -d
```

4. Validate Node is running
* via cURL 
```shell
# Get Status
curl -X GET ${IP_ADDRESS}:32149 -H "command: get status" -H "User-Agent: AnyLog/1.23"  -w "\n"

# Get Processes
curl -X GET ${IP_ADDRESS}:32149 -H "command: get processes" -H "User-Agent: AnyLog/1.23"  -w "\n"
```
* via AnyLog CLI
```shell
ubuntu@anylog-operator:~$ docker attach --detach-keys=ctrl-d anylog-operator 
AL AL anylog-operator +> test node 
--> Test TCP Server ...
run client 139.162.56.87:32148 get status
[From Node 139.162.56.87:32148]  'anylog-operator@139.162.56.87:32148 running'
 
--> Test REST Server ...
rest get where url = http://139.162.56.87:32149 and type = info and command = "get status where format = json" and User-Agent = AnyLog/1.23
{'status': 'anylog-operator@139.162.56.87:32148 running'}
 
--> Test local Blockchain file ...
blockchain test: pass

AL anylog-operator +> get processes 

    Process         Status       Details                                                                    
    ---------------|------------|--------------------------------------------------------------------------|
    TCP            |Running     |Listening on: 139.162.56.87:32148, Threads Pool: 6                        |
    REST           |Running     |Listening on: 139.162.56.87:32149, Threads Pool: 5, Timeout: 20, SSL: None|
    Operator       |Running     |Cluster Member: True, Using Master: 45.79.74.39:32048, Threads Pool: 1    |
    Publisher      |Not declared|                                                                          |
    Blockchain Sync|Running     |Sync every 30 seconds with master using: 45.79.74.39:32048                |
    Scheduler      |Running     |Schedulers IDs in use: [0 (system)] [1 (user)]                            |
    Distributor    |Running     |                                                                          |
    Blobs Archiver |Running     |                                                                          |
    Consumer       |Running     |No peer Operators supporting the cluster                                  |
    MQTT           |Running     |                                                                          |
    Message Broker |Not declared|                                                                          |
    SMTP           |Not declared|                                                                          |
    Streamer       |Running     |Default streaming thresholds are 60 seconds and 10,240 bytes              |
    Query Pool     |Running     |Threads Pool: 3                                                           |
    Kafka Consumer |Not declared|                                                                          |
```