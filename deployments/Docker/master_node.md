# Master Node
Master node is an AnyLog instance that manages the shared metadata. In the case of using a blockchain platform, such 
as _[Jasmy](https://jasmy.global/)_ or Ethereum, this node is redundant. 

For a step-by-step process of what's being done in the background, please visit the [deployment process](master_node_deployment_process.md)


## Requirements
* [Node Setup](../prerequisites.md#docker) - including logging into AnyLog's Docker hub
* [Postgres](database_configuration.md#postgressql)

## Process
For a simplified process, feel free to utilize our deployment script. 
```shell
bash $HOME/deployments/deployment_scripts/deploy_node.sh
```

1. Fill-out the Anylog configurations file for [master node](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-master/anylog_configs.env)
   * If you're using AnyLog overlay network make sure LOCAL_IP address of all the nodes in the network are in the same subnet
   * Make sure the database credentials are the same as what's configured in your PostgresSQL database
   * If you're changing the `ANYLOG_SERVER_PORT` make sure to also change the port associated with the `LEDGER_CONN`
   * A location that's not preset will be autogenerated when node is deployed  

File path: `$HOME/deployments/docker-compose/anylog-master/anylog_configs.env`
```dotenv
# --- General ---
# Information regarding which AnyLog node configurations to enable. By default, even if everything is disabled, AnyLog starts TCP and REST connection protocols
NODE_TYPE=ledger
# Name of the AnyLog instance
NODE_NAME=anylog-master
# Owner of the AnyLog instance
COMPANY_NAME=New Company
# Coordinates of the machine - used by Grafana to map the network
#LOCATION=<GENERAL_LOCATION>
# Country where machine is located
#COUNTRY=<GENERAL_COUNTRY>
# State where machine is located
#STATE=<GENERAL_STATE>
# City where machine is located
#CITY=<GENERAL_CITY>

# --- Networking ---
# External IP address of the machine
#EXTERNAL_IP=<NETWORKING_EXTERNAL_IP>
# Local or  internal network IP address of the machine
#LOCAL_IP=<NETWORKING_LOCAL_IP>
# Configurable (local) IP address that can be used when behind a proxy, or using Kubernetes for static IP
#PROXY_IP=<NETWORKING_PROXY_IP>
# Port address used by AnyLog's TCP protocol to communicate with other nodes in the network
ANYLOG_SERVER_PORT=32048
# Port address used by AnyLog's REST protocol
ANYLOG_REST_PORT=32049
# Port value to be used as an MQTT borker, or some other third-party broker
#ANYLOG_BROKER_PORT=<NETWORKING_ANYLOG_BROKER_PORT>

# --- Database ---
# Physical database type
DB_TYPE=psql
# Username for SQL database connection
DB_USER=admin
# Password correlated to database user
DB_PASSWD=passwd
# Database IP address
DB_IP=127.0.0.1
# Database port number
DB_PORT=5432
# Whether to set autocommit data
AUTOCOMMIT=false
# Whether to start to start system_query logical database
SYSTEM_QUERY=false
# Run system_query using in-memory SQLite. If set to false, will use pre-set database type
MEMORY=False
# Whether to enable NoSQL logical database
NOSQL_ENABLE=false

# --- Blockchain ---
# TCP connection information for Master Node
LEDGER_CONN=127.0.0.1:32048
# How often to sync from blockchain
SYNC_TIME=30 second
# Source of where the data is coming from
BLOCKCHAIN_SOURCE=master
# Where will the copy of the blockchain be stored
BLOCKCHAIN_DESTINATION=file

# --- MQTT ---
# Whether to enable the default MQTT process
ENABLE_MQTT=false

# --- Advanced Settings ---
# Whether to automatically run a local (or personalized) script at the end of the process
DEPLOY_LOCAL_SCRIPT=false
# Number of TCP threads
TCP_THREAD_POOL=6
# How long to wait until REST timeout
REST_TIMEOUT=30
# Number of REST threads
REST_THREADS=5
# Number of parallel queries
QUERY_POOL=3
# When data comes in write to database immidiately, as opposed to waiting for a full buffer
WRITE_IMMEDIATE=true
# If buffer is not full, how long to wait until pushing data through
THRESHOLD_TIME=60 seconds
# Buffer size to reach, at which point data is pushed through
THRESHOLD_VOLUME=10KB
```

2. By default, AnyLog is deployed using our `predevelop` version. Version changes can be done in the [.env](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-master/.env)

File Path: `$HOME/deployments/docker-compose/anylog-master/.env`
```dotenv
BUILD=predevelop
ENV_FILE=anylog_configs.env
CONTAINER_NAME=anylog-master
NETWORK=host
```

3. Deploy Node
```shell
cd $HOME/deployments/docker-compose/anylog-master/
docker-compose up -d
```

4. Validate Node is running
* via cURL 
```shell
# Get Status
curl -X GET ${IP_ADDRESS}:32049 -H "command: get status" -H "User-Agent: AnyLog/1.23"  -w "\n"

# Get Processes
curl -X GET ${IP_ADDRESS}:32049 -H "command: get processes" -H "User-Agent: AnyLog/1.23"  -w "\n"
```
* via AnyLog CLI
```shell
# docker attach --detach-keys=ctrl-d anylog-master 
ubuntu@master-node:~$ docker attach --detach-keys=ctrl-d mastaer-node 
AL master-node +> test node 
--> Test TCP Server ...
run client 45.79.74.39:32048 get status
[From Node 45.79.74.39:32048]  'master-node@45.79.74.39:32048 running'
 
--> Test REST Server ...
rest get where url = http://45.79.74.39:32049 and type = info and command = "get status where format = json" and User-Agent = AnyLog/1.23
{'status': 'master-node@45.79.74.39:32048 running'}
 
--> Test local Blockchain file ...
blockchain test: pass

AL master-node +> get processes 
    Process         Status       Details                                                                  
    ---------------|------------|------------------------------------------------------------------------|
    TCP            |Running     |Listening on: 45.79.74.39:32048, Threads Pool: 6                        |
    REST           |Running     |Listening on: 45.79.74.39:32049, Threads Pool: 5, Timeout: 20, SSL: None|
    Operator       |Not declared|                                                                        |
    Publisher      |Not declared|                                                                        |
    Blockchain Sync|Running     |Sync every 30 seconds with master using: 127.0.0.1:32048                |
    Scheduler      |Running     |Schedulers IDs in use: [0 (system)] [1 (user)]                          |
    Distributor    |Not declared|                                                                        |
    Blobs Archiver |Not declared|                                                                        |
    Consumer       |Not declared|                                                                        |
    MQTT           |Not declared|                                                                        |
    Message Broker |Not declared|No active connection                                                    |
    SMTP           |Not declared|                                                                        |
    Streamer       |Not declared|                                                                        |
    Query Pool     |Running     |Threads Pool: 3                                                         |
    Kafka Consumer |Not declared|                                                                        |
```
