# Publisher Node
A node that supports distribution of data from device(s) to operator nodes. This node is not part of the demo deployment
recommend in getting started, but is ideal for when wanting to send data from devices directly into AnyLog. 

## Requirements
* [Node Setup](../prerequisites.md#docker) - including logging into AnyLog's Docker hub


## Process
For a simplified process, feel free to utilize our deployment script. 
```shell
bash $HOME/deployments/deployment_scripts/deploy_node.sh
```

1. Fill-out the Anylog configurations file for [publisher node](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-publisher/anylog_configs.env)
   * Update the `LEDGER_CONN` information so that it can communicate with the master node (or blockchain)
   * When using AnyLog as an MQTT broker, you can set the `MQTT_BROKER` to **local** and the `MQTT_PORT` to the same value
   as `ANYLOG_BROKER_PORT`. 
   * A location that's not preset will be autogenerated when node is deployed  

File path: `$HOME/deployments/docker-compose/anylog-publisher/anylog_configs.env`
```dotenv
# --- General ---
# Information regarding which AnyLog node configurations to enable. By default, even if everything is disabled, AnyLog starts TCP and REST connection protocols
NODE_TYPE=publisher
# Name of the AnyLog instance
NODE_NAME=anylog-publisher
# Owner of the AnyLog instance
COMPANY_NAME=New Company
# Coordinates of the machine - used by Grafana to map the network
#LOCATION=<GENERAL_LOCATION>
# Country where machine is located
#COUNTRY=<GENERAL_COUNTRY>
# State where machine is located
#STATE=<GENERAL_STATE>
# City where machine is located
#CITY=<GENERAL_CITY>

# --- Networking ---
# External IP address of the machine
#EXTERNAL_IP=<NETWORKING_EXTERNAL_IP>
# Local or  internal network IP address of the machine
#LOCAL_IP=<NETWORKING_LOCAL_IP>
# Configurable (local) IP address that can be used when behind a proxy, or using Kubernetes for static IP
#PROXY_IP=<NETWORKING_PROXY_IP>
# Port address used by AnyLog's TCP protocol to communicate with other nodes in the network
ANYLOG_SERVER_PORT=32248
# Port address used by AnyLog's REST protocol
ANYLOG_REST_PORT=32249
# Port value to be used as an MQTT borker, or some other third-party broker
#ANYLOG_BROKER_PORT=<NETWORKING_ANYLOG_BROKER_PORT>

# --- Database ---
# Physical database type
DB_TYPE=sqlite
# Username for SQL database connection
#DB_USER=<DATABASE_DB_USER>
# Password correlated to database user
#DB_PASSWD=<DATABASE_DB_PASSWD>
# Database IP address
DB_IP=127.0.0.1
# Database port number
DB_PORT=5432
# Whether to set autocommit data
AUTOCOMMIT=false
# Whether to start to start system_query logical database
SYSTEM_QUERY=false
# Run system_query using in-memory SQLite. If set to false, will use pre-set database type
MEMORY=False
# Whether to enable NoSQL logical database
NOSQL_ENABLE=false
# Physical database type
NOSQL_TYPE=mongo
# Username for SQL database connection
#NOSQL_USER=<DATABASE_NOSQL_USER>
# Password correlated to database user
#NOSQL_PASSWD=<DATABASE_NOSQL_PASSWD>
# Database IP address
NOSQL_IP=127.0.0.1
# Database port number
NOSQL_PORT=27017
# Store blobs in database
NOSQL_BLOBS_DBMS=true
# Store blobs in folder
NOSQL_BLOBS_FOLDER=true
# Compress stored blobs
NOSQL_BLOBS_COMPRESS=false
# Whether (re)store a blob if already exists
NOSQL_BLOBS_REUSE=true

# --- Blockchain ---
# TCP connection information for Master Node
LEDGER_CONN=127.0.0.1:32048
# How often to sync from blockchain
SYNC_TIME=30 second
# Source of where the data is coming from
BLOCKCHAIN_SOURCE=master
# Where will the copy of the blockchain be stored
BLOCKCHAIN_DESTINATION=file

# --- Publisher ---
# Location of logical database name within file name
DBMS_FILE_LOCATION=file_name[0]
# Location of table name within file name
TABLE_FILE_LOCATION=dbms_file_location[1]
# Compress JSON and SQL file(s) backup
PUBLISHER_COMPRESS_FILE=true

# --- MQTT ---
# Whether to enable the default MQTT process
ENABLE_MQTT=false
# Whether to enable MQTT logging process
MQTT_LOG=false
# IP address of MQTT broker
MQTT_BROKER=driver.cloudmqtt.com
# Port associated with MQTT broker
MQTT_PORT=18785
# User associated with MQTT broker
MQTT_USER=ibglowct
# Password associated with MQTT user
MQTT_PASSWD=MSY4e009J7ts
# Topic to get data for
MQTT_TOPIC=anylogedgex
# Logical database name
#MQTT_DBMS=<MQTT_MQTT_DBMS>
# Table where to store data
MQTT_TABLE=rand_data
# Timestamp column name
MQTT_TIMESTAMP_COLUMN=now
# Value column name
MQTT_VALUE_COLUMN=bring [readings][][value]
# Column value type
MQTT_VALUE_COLUMN_TYPE=float

# --- Advanced Settings ---
# Whether to automatically run a local (or personalized) script at the end of the process
DEPLOY_LOCAL_SCRIPT=false
# Number of TCP threads
TCP_THREAD_POOL=6
# How long to wait until REST timeout
REST_TIMEOUT=30
# Number of REST threads
REST_THREADS=5
# Number of parallel queries
QUERY_POOL=3
# When data comes in write to database immidiately, as opposed to waiting for a full buffer
WRITE_IMMEDIATE=true
# If buffer is not full, how long to wait until pushing data through
THRESHOLD_TIME=60 seconds
# Buffer size to reach, at which point data is pushed through
THRESHOLD_VOLUME=10KB
```

2. By default, AnyLog is deployed using our `predevelop` version. Version changes can be done in the [.env](https://github.com/AnyLog-co/deployments/blob/master/docker-compose/anylog-publisher/.env)

File Path: `$HOME/deployments/docker-compose/anylog-publisher/.env`
```dotenv
BUILD=predevelop
ENV_FILE=anylog_configs.env
CONTAINER_NAME=anylog-master
NETWORK=host
```

3. Deploy Node
```shell
cd $HOME/deployments/docker-compose/anylog-publisher/
docker-compose up -d
```

4. Validate Node is running
* via cURL 
```shell
# Get Status
curl -X GET ${IP_ADDRESS}:32049 -H "command: get status" -H "User-Agent: AnyLog/1.23"  -w "\n"

# Get Processes
curl -X GET ${IP_ADDRESS}:32049 -H "command: get processes" -H "User-Agent: AnyLog/1.23"  -w "\n"
```
* via AnyLog CLI
```shell
 
ubuntu@anylog-publisher:~$ docker attach --detach-keys=ctrl-d anylog-publisher 
AL anylog-publisher +> test node 

--> Test TCP Server ...
run client 172.104.180.110:32248 get status
[From Node 172.104.180.110:32248]  'anylog-publisher@172.104.180.110:32248 running'

--> Test REST Server ...
rest get where url = http://172.104.180.110:32249 and type = info and command = "get status where format = json" and User-Agent = AnyLog/1.23
{'status': 'anylog-publisher@172.104.180.110:32248 running'}
 
--> Test local Blockchain file ...
blockchain test: pass

AL anylog-publisher +> get processes

    Process         Status       Details                                                                      
    ---------------|------------|----------------------------------------------------------------------------|
    TCP            |Running     |Listening on: 172.104.180.110:32248, Threads Pool: 6                        |
    REST           |Running     |Listening on: 172.104.180.110:32249, Threads Pool: 5, Timeout: 20, SSL: None|
    Operator       |Not declared|                                                                            |
    Publisher      |Running     |                                                                            |
    Blockchain Sync|Running     |Sync every 30 seconds with master using: 45.79.74.39:32048                  |
    Scheduler      |Running     |Schedulers IDs in use: [0 (system)] [1 (user)]                              |
    Distributor    |Not declared|                                                                            |
    Blobs Archiver |Not declared|                                                                            |
    Consumer       |Not declared|                                                                            |
    MQTT           |Running     |                                                                            |
    Message Broker |Running     |Listening on: 172.104.180.110:32250, Threads Pool: 4                        |
    SMTP           |Not declared|                                                                            |
    Streamer       |Running     |Default streaming thresholds are 60 seconds and 10,240 bytes                |
    Query Pool     |Running     |Threads Pool: 3                                                             |
    Kafka Consumer |Not declared|                                                                            |
```